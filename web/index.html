<!DOCTYPE html>
<html>
<head>
  <!-- Dla osadzania w SharePoint: jeśli build publikujesz w katalogu CDN / Asset Library,
       <base href="./"> zwykle bezpieczniejsze niż placeholder gdy ścieżka nie jest root. -->
  <!-- <base href="./"> -->
  <!-- Placeholder używany gdy budujesz z --base-href; pozostaw jeśli stosujesz wiele środowisk -->
  <base href="$FLUTTER_BASE_HREF">
  <!-- Jeśli NIE używasz --base-href możesz zamienić powyższe na: <base href="./"> -->

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="Protokół Serwisowy">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="protokol_serwisowy_app">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>protokol_serwisowy_app</title>
  <link rel="manifest" href="manifest.json">
  <script>
    window.flutterConfiguration = { renderer: "html", assetBase: "/" };
    // Prosty logger
    window.addEventListener('error', e => console.error('[BOOT ERR]', e.error || e.message));
    window.addEventListener('unhandledrejection', e => console.error('[UNHANDLED]', e.reason));
    // A11y: dodaj alt/title dla obrazów w tym dokumencie, jeśli brak
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('img:not([alt])').forEach(img => {
        const inferred = img.getAttribute('title') || 'image';
        img.setAttribute('alt', inferred);
        if (!img.hasAttribute('title')) img.setAttribute('title', inferred);
      });
    });
  </script>

  <!-- Enforce accessible viewport (remove user-scalable/max-scale added by Flutter) -->
  <script>
    (function enforceA11yViewport() {
      const desired = 'width=device-width, initial-scale=1';
      const apply = () => {
        const m = document.head.querySelector('meta[flt-viewport]') || document.head.querySelector('meta[name="viewport"][flt-viewport]');
        if (m && m.getAttribute('content') !== desired) {
          m.setAttribute('content', desired);
        }
      };
      // apply now and observe future injections
      apply();
      new MutationObserver(apply).observe(document.head, { childList: true, subtree: true });
      window.addEventListener('load', apply);
    })();
  </script>

  <style>
    /* Panel z przyciskami – ukryty (zostaje dla kompatybilności, ale niewidoczny) */
    #spup-tools{
      display:none !important;
      position:fixed; right:10px; bottom:10px;
      z-index:2147483647;
      background:#fff8; padding:8px 10px; border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,.2);
      gap:8px; align-items:center;
      font-family:system-ui,Segoe UI,Arial,sans-serif;
    }
    #spup-tools button{ padding:6px 10px; font-size:14px; cursor:pointer; }
  </style>
</head>
<body>
  <!-- Panel pomocniczy: osobne przyciski -->
  <div id="spup-tools">
    <button id="btnGen" style="margin-right:8px">Generuj PDF</button>
    <button id="btnSave">Zapisz do SharePoint</button>
  </div>
  <script>
    // Minimalny, poprawny PDF (fallback), metadane, oczekiwanie na PDF
    function makeSimplePdf(meta) {
      const b64='JVBERi0xLjQKJcTl8uXrp/Og0MTGCjEgMCBvYmoKPDwvVHlwZSAvQ2F0YWxvZyAvUGFnZXMgMiAwIFI+PgplbmRvYmoKMiAwIG9iago8PC9UeXBlIC9QYWdlcyAvQ291bnQgMSAvS2lkcyBbMyAwIFJdPj4KZW5kb2JqCjMgMCBvYmoKPDwvVHlwZSAvUGFnZSAvUGFyZW50IDIgMCBSIC9NZWRpYUJveCBbMCAwIDYxMiA3OTJdIC9Db250ZW50cyA0IDAgUiAvUmVzb3VyY2VzIDw8L0ZvbnQgPDwvRjEgNSAwIFI+Pj4+PgplbmRvYmoKNCAwIG9iago8PC9MZW5ndGggNTQ+PgpzdHJlYW0KQlQKL0YxIDI0IFRmCjEwMCA3MDAgVGQKKEtyb3RrbzogUHJvdG9rb2wgc2Vyd2lzb3d5KSBUagpFVAplbmRzdHJlYW0KZW5kb2JqCjUgMCBvYmoKPDwvVHlwZSAvRm9udCAvU3VidHlwZSAvVHlwZTEgL0Jhc2VGb250IC9IZWx2ZXRpY2E+PgplbmRvYmoKeHJlZgowIDYKMDAwMDAwMDAwMCA2NTUzNSBmIAowMDAwMDAwMDY3IDAwMDAwIG4gCjAwMDAwMDAxNTUgMDAwMDAgbiAKMDAwMDAwMDI2MyAwMDAwMCBuIAowMDAwMDAwMzU1IDAwMDAwIG4gCjAwMDAwMDA0NzAgMDAwMDAgbiAKdHJhaWxlcgo8PC9TaXplIDYgL1Jvb3QgMSAwIFI+PgpzdGFydHhyZWYKNTEyCiUlRU9G';
      const bin=atob(b64), bytes=new Uint8Array(bin.length);
      for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
      return new Blob([bytes],{type:'application/pdf'});
    }
    window.setProtocolMeta = function(meta){ window.__lastProtocolMeta = meta || {}; };
    async function waitForPdfBlob(timeoutMs=20000) {
      const t=Date.now();
      while(Date.now()-t<timeoutMs){
        const b=window.__lastPdfBlob;
        if(b instanceof Blob && (b.type||'').toLowerCase()==='application/pdf' && b.size>0) return b;
        await new Promise(r=>setTimeout(r,250));
      }
      return null;
    }
    function sanitize(s){ return String(s||'').normalize('NFKD').replace(/[^\w\s\-\.]/g,'').replace(/\s+/g,'_'); }
    function buildFileName(meta){
      const m = meta || window.__lastProtocolMeta || {};
      const who = sanitize(m.firma || m.imieNazwisko || 'Protokol');
      const addr = sanitize(m.adres || '');
      const dt = sanitize((m.date || new Date().toISOString().slice(0,10)));
      const parts = [who, addr, dt].filter(Boolean);
      return (parts.join('__') || 'Protokol') + '.pdf';
    }

    // Podpinamy się pod „stary” przycisk: szukaj po tekście
    (function hookOldButton(){
      function findOldBtn(){
        const nodes = Array.from(document.querySelectorAll('button,[role="button"]'));
        return nodes.find(n => /pdf|zapisz|protok(o|ó)|sharepoint/i.test(n.textContent||''));
      }
      async function onOldClick(e){
        try{
          // Pozwól oryginalnemu handlerowi wykonać generowanie PDF
          setTimeout(async () => {
            // Jeśli aplikacja nie podstawiła PDF-a, wygeneruj minimalny
            if(!(window.__lastPdfBlob instanceof Blob)){
              // opcjonalne podpowiedzi dla metadanych
              const m = window.__lastProtocolMeta || {};
              window.__lastProtocolMeta = {
                firma: m.firma ?? undefined,
                imieNazwisko: m.imieNazwisko ?? undefined,
                adres: m.adres ?? undefined,
                date: m.date ?? new Date().toISOString().slice(0,10)
              };
              window.__lastPdfBlob = makeSimplePdf(window.__lastProtocolMeta);
            }
            const blob = await waitForPdfBlob(20000) || makeSimplePdf(window.__lastProtocolMeta);
            if(!window.SPUP) throw new Error('SPUP nie został załadowany');
            await window.SPUP.ensureM365Ready();
            const name = buildFileName(window.__lastProtocolMeta);
            const res = await window.SPUP.uploadProtocolPdfDefault(blob, name, { folderPath: '' });
            console.info('Wgrano:', res.webUrl);
            alert('Wgrano: ' + res.webUrl);
          }, 0);
        }catch(err){
          console.error('Upload error:', err);
          alert('Błąd zapisu: ' + (err?.message || err));
        }
      }
      function attach(){
        const btn = findOldBtn();
        if(btn && !btn.__spupBound){
          btn.addEventListener('click', onOldClick);
          btn.__spupBound = true;
          console.info('[SPUP] hooked old button:', btn);
        }
      }
      // próby kilkukrotne (Flutter może późno wstawić DOM)
      attach();
      let tries=0;
      const iv=setInterval(()=>{ if(++tries>20) return clearInterval(iv); attach(); }, 500);
      document.addEventListener('SPUP:rebind', attach);
    })();
  </script>

  <script src="./msal-sharepoint.js?v=5" defer></script>
  <!-- Bootstrap Flutter -->
  <script src="flutter_bootstrap.js" async></script>
</body>
</html>